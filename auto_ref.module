<?php

$path = drupal_get_path('module', 'auto_ref') . '/classes/auto_ref.class.php';
require_once($path);


$widget = array();

/*
 * Tell Drupal about the field widget
*/
function auto_ref_field_widget_info() {
    return array(
        'auto_ref_field_widget' => array(
          'label' => t('Auto Reference'),
          'field types' => array('entityreference'),
          'behaviors' => array(
             'multiple values' => FIELD_BEHAVIOR_DEFAULT,
           ),
          'settings' => array(
          	 'duration' => '-2 year',
           ),
        ),
    );    
}


/**
* Tell Drupal about the field widget setting
*/

function auto_ref_field_widget_settings_form($field, $instance){
	array_push($widget, $instance['widget']);
    variable_set('duration', $instance['widget']);

	$form['duration'] = array(
      '#type' => 'select',
      '#title' => t('Duration'),
      '#options' => array(
      	 '-1 day' => '-1 day',
      	 '-1 week' => '-1 week', 
      	 '-1 month' => '-1 month', 
      	 '-3 month' => '-3 month',
      	 '-6 month' => '-6 month',
      	 '-1 year' => '-1 year',
      	 '-18 month' => '-18 month',
      	 '-2 year' => '-2 year',
      	 '-3 year' => '-3 year',
      	 '-5 year' => '-5 year'),
      '#default_value' => $instance['widget']['settings']['duration'],
      '#weight' => -30,
	);
	return $form;
}


/*
 * Tell Drupal how to display your widget
*/
function auto_ref_field_widget_form(&$form,&$form_state,$field,$instance,$langcode,$items,$delta,$element) {
   
   // Ensure that the entity target type exists before displaying the widget.
   $entity_info = entity_get_info($field['settings']['target_type']);

   if (empty($entity_info)){
    return;
   }

   $entity_type = $instance['entity_type'];
   $entity = isset($element['#entity']) ? $element['#entity'] : NULL;
   $handler = entityreference_get_selection_handler($field, $instance, $entity_type, $entity);
   
   if ($instance['widget']['type'] == 'auto_ref_field_widget'){
       $entity_ids = array();
       $entity_labels = array();
        // Build an array of entities ID.
       foreach ($items as $item) {
        $entity_ids[] = $item['target_id'];
       }
       
       // Load those entities and loop through them to extract their labels.
       $entities = entity_load($field['settings']['target_type'], $entity_ids);

       foreach ($entities as $entity_id => $entity_item) {
        $label = $handler->getLabel($entity_item);
        $key = "$label ($entity_id)";
        // Labels containing commas or quotes must be wrapped in quotes.
        if (strpos($key, ',') !== FALSE || strpos($key, '"') !== FALSE) {
            $key = '"' . str_replace('"', '""', $key) . '"';
        }
        $entity_labels[] = $key;
       }

       $element += array(
        '#type' => 'hidden',
        #'#autocomplete_path' => $autocomplete_path,
        '#size' => $instance['widget']['settings']['size'],
        #'#element_validate' => array('_entityreference_auto_ref_validate'),
       );
       $attr_entity = get_object_vars($entity);
       foreach ($attr_entity as $key => $value) {
        
         krumo($key);
     
       }
       return array('target_id' => $element); 

   }
}

   
function auto_ref_entity_presave($entity, $type){

	  $attr_entity = get_object_vars($entity);
	  $date = $entity->field_cot_date[LANGUAGE_NONE][0]['value'];
      $date = strtotime("$date");
      $date = date('Y-m-d', strtotime(AutoRef::getDuration(), $date));
      $ref = $entity->field_cot_ref[LANGUAGE_NONE][0]['target_id'];
      
      /*foreach ($attr_entity as $key => $value) {
        if ($value == 1) {
         echo $key;
        }
      }*/
       $query = db_select('field_data_field_cot_ref', 'cot_ref');
       $query->join('field_data_field_cot_date', 'date_ref', "cot_ref.entity_id = date_ref.entity_id");
       $query->fields('cot_ref', array('entity_id'))
            ->condition("cot_ref.field_cot_ref_target_id", $ref, '=')
            ->condition("date_ref.field_cot_date_value", "$date", '<=')
            ->orderBy('date_ref.field_cot_date_value', 'DESC')
            ->range(0,1);
      
       $result = $query->execute();
       foreach ($result as $record) {
          $entity->field_autoref[LANGUAGE_NONE][0]['target_id'] = $record->entity_id;
       } 	 
}


 /*'1w' => '-1 week', 
      	 '1m' => '-1 month', 
      	 '3m' => '-3 month',
      	 '6m' => '-6 month',
      	 '1y' => '-1 year',
      	 '18m' => '-18 month',
      	 '2y' => '-2 year',
      	 '3y' => '-3 year',
      	 '5y' => '-5 year'
      	 */